<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Incentive Calculator v2.2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root{
    --bg: #f8f9fa;
    --card: #ffffff;
    --accent: #0A7E8C;
    --muted: #666;
    --darkblue: #0047AB;
    --darkbrown: #5C4033;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family:Inter, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background:var(--bg);
    color:#222;
    transition: background .3s, color .3s;
    display:flex;
    justify-content:center;
    padding:28px 16px;
  }

  .app {
    width:100%;
    max-width:980px;
  }

  header.app-header{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-bottom:18px;
  }
  .title-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  h1{ margin:0; font-size:28px; color:var(--accent); }
  .sub-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .version{ color:var(--muted); font-size:13px; }
  .dark-toggle{
    cursor:pointer;
    font-size:20px;
    color:var(--accent);
    user-select:none;
  }

  /* pill tabs */
  .tabs{
    display:flex;
    gap:8px;
    margin: 12px 0;
  }
  .pill{
    padding:8px 14px;
    border-radius:999px;
    background:#e9f6f6;
    color:#08373a;
    cursor:pointer;
    font-weight:600;
    border:1px solid rgba(10,126,140,0.06);
    transition:transform .12s, background .12s;
  }
  .pill:hover{ transform:translateY(-2px); }
  .pill.active{
    background:var(--accent);
    color:#fff;
    box-shadow: 0 6px 18px rgba(10,126,140,0.12);
  }

  .card{
    background:var(--card);
    border-radius:14px;
    box-shadow:0 8px 30px rgba(16,24,40,0.06);
    padding:22px;
  }

  /* input area grid */
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }
  label{display:block; font-weight:600; margin-bottom:6px; color:#333;}
  input[type="number"], input[type="file"]{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #d3d6d8;
    font-size:15px;
  }
  input[type="file"]{ padding:8px; }

  .btn{
    display:inline-block;
    padding:12px 16px;
    border-radius:10px;
    background:var(--accent);
    color:#fff;
    font-weight:700;
    border:none;
    cursor:pointer;
    margin-top:12px;
  }
  .btn.secondary{
    background:#fff;
    color:var(--accent);
    border:1px solid rgba(10,126,140,0.15);
    box-shadow:none;
  }

  .results { margin-top:18px; line-height:1.6; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

  .value{
    font-weight:700;
  }

  .darkBlue{ color:var(--darkblue); font-style:italic; font-weight:700; }
  .darkBrown{ color:var(--darkbrown); font-style:italic; font-weight:700; }
  .salem{ color:var(--accent); font-weight:800; }

  .highlight-total{
    margin-top:12px;
    background: #e8fffb;
    border-left:6px solid var(--accent);
    padding:12px;
    border-radius:8px;
    font-size:18px;
    font-weight:800;
  }

  .note{ color:var(--muted); font-size:13px; margin-bottom:8px; }

  /* table */
  .table-wrap{ margin-top:14px; overflow:auto; border-radius:8px; border:1px solid #e6eef0; }
  table{ width:100%; border-collapse:collapse; min-width:700px; }
  th, td{ padding:10px 12px; border-bottom:1px solid #eef3f4; text-align:left; }
  th{ background:var(--accent); color:#fff; font-weight:700; position:sticky; top:0; }
  tr:nth-child(even){ background:#fbfdfd; }
  tr:hover{ background:#f0fbfb; }

  .small{ font-size:13px; color:var(--muted); }

  /* dark mode overrides */
  body.dark{
    background:#0b0f11;
    color:#dbe6e6;
  }
  body.dark .card{ background:#0f1415; box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
  body.dark .pill{ background:rgba(255,255,255,0.03); color:#cfeeea; border-color:rgba(255,255,255,0.03);}
  body.dark .pill.active{ background:var(--accent); color:#001; }
  body.dark input[type="number"], body.dark input[type="file"]{ background:#1c2223; border-color:#2a3637; color:#dfefef; }
  body.dark th{ background: #063a3c; color:#fff; }
  body.dark tr:nth-child(even){ background:#0f1616; }
  body.dark tr:hover{ background:#082425; }
  body.dark .highlight-total{ background:#003733; color:#dff7f2; border-left-color: #00bfa6; }
  body.dark .darkBlue{ color:#66b3ff; }
  body.dark .darkBrown{ color:#e6b76b; }
  body.dark .salem{ color:#00bfa6; }
</style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-row">
        <h1>Smart Incentive Calculator</h1>
        <div class="dark-toggle" id="darkToggle" title="Toggle dark mode">‚òÄÔ∏è</div>
      </div>
      <div class="sub-row">
        <div class="version">v2.2</div>
      </div>
    </header>

    <div class="tabs" role="tablist" aria-label="Calculator tabs">
      <button class="pill active" id="tab-ind" onclick="activateTab('individual')">Individual</button>
      <button class="pill" id="tab-bulk" onclick="activateTab('bulk')">Bulk Upload</button>
    </div>

    <!-- INDIVIDUAL CARD -->
    <section id="individual" class="card" aria-labelledby="tab-ind" style="display:block;">
       <div class="note small">This tool runs entirely in your browser ‚Äî no data stored anywhere.</div>
      <div class="grid">
        <div>
          <label for="ind-target">Sales Target (AED)</label>
          <input id="ind-target" type="number" placeholder="700000" />
        </div>

        <div>
          <label for="ind-total">Total Sales (AED)</label>
          <input id="ind-total" type="number" placeholder="735000" />
        </div>

        <div>
          <label for="ind-personal">Personal Sales (AED)</label>
          <input id="ind-personal" type="number" placeholder="30450" />
        </div>

        <div>
          <label for="ind-count">Number of Salespersons</label>
          <input id="ind-count" type="number" value="25" />
        </div>
      </div>

      <button class="btn" onclick="calculateIndividual()">Calculate</button>

      <div id="ind-results" class="results"></div>
      <div id="ind-quote" class="small" style="margin-top:8px;color:var(--muted)"></div>
    </section>

    <!-- BULK CARD -->
    <section id="bulk" class="card" aria-labelledby="tab-bulk" style="display:none; margin-top:16px;">
      <div class="note">Upload Excel file with Staff and Total as header.
      Extra columns are ignored. File must be .xlsx or .xls.</div>

      <div class="grid">
        <div>
          <label for="bulk-target">Sales Target (AED)</label>
          <input id="bulk-target" type="number" placeholder="700000" />
        </div>

        <div>
          <label for="bulk-file">Excel File (.xlsx, .xls)</label>
          <input id="bulk-file" type="file" accept=".xlsx,.xls" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <button class="btn" onclick="calculateBulk()">Process Upload</button>
        <button class="btn secondary" id="downloadBtn" onclick="downloadBulk()" style="display:none;margin-left:10px;">Download Results</button>
      </div>

      <div id="bulk-results" style="margin-top:14px;"></div>
    </section>
  </div>

<script>
/* UI helpers */
function activateTab(name){
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.card').forEach(c=>c.style.display='none');
  if(name==='individual'){
    document.getElementById('tab-ind').classList.add('active');
    document.getElementById('individual').style.display='block';
  } else {
    document.getElementById('tab-bulk').classList.add('active');
    document.getElementById('bulk').style.display='block';
  }
}

/* Dark mode toggle */
const darkToggle = document.getElementById('darkToggle');
darkToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  darkToggle.textContent = document.body.classList.contains('dark') ? 'üåô' : '‚òÄÔ∏è';
});

/* Motivational quotes only for individual tab */
const quotes = [
  "Every sale brings you closer to success.",
  "Push a little harder ‚Äî your future self will thank you.",
  "Small wins compound into big results.",
  "Be the reason someone earns a compliment today."
];

/* ---------- INDIVIDUAL CALC ---------- */
function calculateIndividual(){
  const target = parseFloat(document.getElementById('ind-target').value);
  const total = parseFloat(document.getElementById('ind-total').value);
  const personal = parseFloat(document.getElementById('ind-personal').value);
  const count = parseInt(document.getElementById('ind-count').value,10);
  const out = document.getElementById('ind-results');
  const quoteEl = document.getElementById('ind-quote');
  out.innerHTML=''; quoteEl.textContent='';

  if(!target || !total || !personal || !count){ out.innerHTML = "<div style='color:#d9534f'>Please fill all fields</div>"; return; }

  const pct = (total / target) * 100;
  let tierText='Below Target (No Incentive)';
  let tierPct = 0;
  if(pct >=85 && pct <=100){ tierText = 'Tier 1 (2.5%)'; tierPct = 0.025; }
  else if(pct >=101 && pct <=110){ tierText = 'Tier 2 (3%)'; tierPct = 0.03; }
  else if(pct >=111){ tierText = 'Tier 3 (3.5%)'; tierPct = 0.035; }

  const pool = total * tierPct;
  const equalSplit = (pool * 0.7) / count;
  const personal30 = (personal / total) * (pool * 0.3);
  const totalIncentive = equalSplit + personal30;

  // Projection if user sold AED 1695 (same tierPct logic based on new totals)
  const extra = 1695;
  const newTotal = total + extra;
  const newPersonal = personal + extra;
  const newPct = (newTotal / target) * 100;
  let newTierPct = 0;
  if(newPct >=85 && newPct <=100) newTierPct = 0.025;
  else if(newPct >=101 && newPct <=110) newTierPct = 0.03;
  else if(newPct >=111) newTierPct = 0.035;
  const newPool = newTotal * newTierPct;
  const newEqualSplit = (newPool * 0.7) / count;
  const newPersonal30 = (newPersonal / newTotal) * (newPool * 0.3);
  const newTotalIncentive = newEqualSplit + newPersonal30;
  const diff = newTotalIncentive - totalIncentive;

  out.innerHTML = `
    <div><strong>Incentive Tier:</strong> ${tierText}</div>
    <div><strong>Equal Split (70%):</strong> <span class="darkBlue">AED ${equalSplit.toFixed(3)}</span></div>
    <div><strong>Personal Sales %:</strong> ${((personal/total)*100).toFixed(3)}%</div>
    <div><strong>Personal 30%:</strong> <span class="darkBrown">AED ${personal30.toFixed(3)}</span></div>
    <div class="highlight-total">Total Incentive: <span class="salem">AED ${totalIncentive.toFixed(2)}</span></div>
    <div style="margin-top:10px" class="small">If you sell an extra package of AED ${extra}: projected incentive AED ${newTotalIncentive.toFixed(2)} (difference ${diff>=0?'+':''}${diff.toFixed(2)} AED)</div>
  `;

  // random quote
  const q = quotes[Math.floor(Math.random()*quotes.length)];
  quoteEl.textContent = q;
}

/* ---------- BULK CALC (merged-row pattern) ----------

 Pattern assumed:
 Row 1: headers (A1 / B1)
 Row 2: staff name (A2)
 Row 3: staff total (B3)
 Row 4: staff name (A4)
 Row 5: staff total (B5)
 ...
 We will read starting from row index 2 (1-based), step by 2: nameRow = r, totalRow = r+1
 Column indices: A => 0, B => 1
 Extra columns ignored.
 ---------- */

function calculateBulk(){
  const target = parseFloat(document.getElementById('bulk-target').value);
  const fileInput = document.getElementById('bulk-file');
  const file = fileInput.files && fileInput.files[0];
  const out = document.getElementById('bulk-results');
  const dwn = document.getElementById('downloadBtn');
  out.innerHTML=''; dwn.style.display='none'; window._bulkExportData = null;

  if(!target || !file){ out.innerHTML = "<div style='color:#d9534f'>Please provide sales target and select an Excel file.</div>"; return; }
  const reader = new FileReader();
  reader.onload = function(evt){
    try{
      const array = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(array, {type:'array'});
      const first = workbook.SheetNames[0];
      const sheet = workbook.Sheets[first];
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1});

      if(rows.length < 3){ out.innerHTML = "<div style='color:#d9534f'>Excel looks too short ‚Äî need at least header + one staff block.</div>"; return; }

      const staffList = [];
      // start from row index 1 (0-based => row 2 in Excel)
      for(let r = 1; r < rows.length; r += 2){
        const nameRow = rows[r];       // expected to contain staff name at col 0
        const totalRow = rows[r+1];    // expected to contain total at col 1
        if(!nameRow) continue;
        const staffName = nameRow[0];
        if(!staffName) continue;
        const totalVal = totalRow && totalRow[1];
        const totalNum = totalVal === undefined || totalVal === null ? NaN : Number(totalVal);
        if(isNaN(totalNum)) continue;
        staffList.push({ Staff: String(staffName).trim(), Total: Number(totalNum) });
      }

      if(staffList.length === 0){
        out.innerHTML = "<div style='color:#d9534f'>No valid staff/name & total pairs found using the merged-row pattern.</div>";
        return;
      }

      // compute totals
      const teamTotal = staffList.reduce((s,c)=>s + c.Total, 0);
      const pct = (teamTotal / target) * 100;
      let tierText='Below Target (No Incentive)', tierPct=0;
      if(pct >=85 && pct <=100){ tierText = 'Tier 1 (2.5%)'; tierPct = 0.025; }
      else if(pct >=101 && pct <=110){ tierText = 'Tier 2 (3%)'; tierPct = 0.03; }
      else if(pct >=111){ tierText = 'Tier 3 (3.5%)'; tierPct = 0.035; }

      const pool = teamTotal * tierPct;
      const equalSplit = (pool * 0.7) / staffList.length;
      // fill per-staff values
      staffList.forEach(s=>{
        s.PersonalPercent = ((s.Total / teamTotal) * 100).toFixed(3);
        s.Personal30 = ((s.Total / teamTotal) * (pool * 0.3));
        s.Personal30_display = s.Personal30.toFixed(3);
        s.EqualSplit = Number(equalSplit.toFixed(3));
        s.TotalIncentive = Number((equalSplit + s.Personal30).toFixed(2));
      });

      // sort by TotalIncentive desc
      staffList.sort((a,b) => b.TotalIncentive - a.TotalIncentive);

      // render results table and meta
      let html = `<div><strong>Tier:</strong> ${tierText} &nbsp; <span class="small">(${pct.toFixed(2)}% of target)</span></div>`;
      html += `<div style="margin-top:6px"><strong>Total Sales:</strong> AED ${teamTotal.toFixed(2)}</div>`;
      html += `<div style="margin-top:6px"><strong>Equal Split (per staff):</strong> <span class="darkBlue">AED ${equalSplit.toFixed(3)}</span></div>`;

      html += `<div class="table-wrap"><table><thead><tr>
        <th>Staff</th><th>Total (AED)</th><th>Personal %</th><th>Personal 30% (AED)</th><th>Equal Split (AED)</th><th>Total Incentive (AED)</th>
      </tr></thead><tbody>`;

      staffList.forEach(s=>{
        html += `<tr>
          <td>${escapeHtml(s.Staff)}</td>
          <td>${s.Total.toFixed(2)}</td>
          <td>${s.PersonalPercent}%</td>
          <td>${s.Personal30_display}</td>
          <td>${s.EqualSplit.toFixed(3)}</td>
          <td>${s.TotalIncentive.toFixed(2)}</td>
        </tr>`;
      });

      html += `</tbody></table></div>`;
      out.innerHTML = html;

      // prepare data for download (export full columns incl EqualSplit)
      // produce clean objects with proper column names
      const exportData = staffList.map(s => ({
        Staff: s.Staff,
        Total: Number(s.Total.toFixed(2)),
        PersonalPercent: Number(s.PersonalPercent),
        Personal30: Number(s.Personal30.toFixed(3)),
        EqualSplit: Number(s.EqualSplit.toFixed(3)),
        TotalIncentive: Number(s.TotalIncentive.toFixed(2))
      }));

      window._bulkExportData = exportData;
      document.getElementById('downloadBtn').style.display = 'inline-block';
    } catch(err){
      console.error(err);
      out.innerHTML = "<div style='color:#d9534f'>Failed to parse the file. Make sure it's a valid .xlsx/.xls workbook.</div>";
    }
  };
  reader.readAsArrayBuffer(file);
}

/* download prepared export */
function downloadBulk(){
  if(!window._bulkExportData || !window._bulkExportData.length) return;
  const ws = XLSX.utils.json_to_sheet(window._bulkExportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Incentives');
  XLSX.writeFile(wb, 'Bulk_Incentives_v2.1.xlsx');
}

/* small helper */
function escapeHtml(str){
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

/* allow Enter key to trigger calculate on individual inputs */
['ind-target','ind-total','ind-personal','ind-count'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') calculateIndividual(); });
});
</script>
</body>
</html>
